"use strict";(self.webpackChunkdoeks_website=self.webpackChunkdoeks_website||[]).push([[1430],{8244:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>h,frontMatter:()=>i,metadata:()=>o,toc:()=>c});var t=s(5893),r=s(1151);const i={sidebar_position:5,sidebar_label:"EMR on EKS with CDK"},l="EMR on EKS with CDK blueprint",o={id:"blueprints/amazon-emr-on-eks/emr-eks-cdk",title:"EMR on EKS with CDK blueprint",description:"Introduction",source:"@site/docs/blueprints/amazon-emr-on-eks/emr-eks-cdk.md",sourceDirName:"blueprints/amazon-emr-on-eks",slug:"/blueprints/amazon-emr-on-eks/emr-eks-cdk",permalink:"/data-on-eks/docs/blueprints/amazon-emr-on-eks/emr-eks-cdk",draft:!1,unlisted:!1,editUrl:"https://github.com/awslabs/data-on-eks/blob/main/website/docs/blueprints/amazon-emr-on-eks/emr-eks-cdk.md",tags:[],version:"current",sidebarPosition:5,frontMatter:{sidebar_position:5,sidebar_label:"EMR on EKS with CDK"},sidebar:"blueprints",previous:{title:"EMR on EKS with ACK Controller",permalink:"/data-on-eks/docs/blueprints/amazon-emr-on-eks/emr-eks-ack"},next:{title:"EMR on EKS with Fargate",permalink:"/data-on-eks/docs/blueprints/amazon-emr-on-eks/emr-eks-fargate"}},a={},c=[{value:"Introduction",id:"introduction",level:2},{value:"Deploying the Solution",id:"deploying-the-solution",level:2},{value:"Prerequisites",id:"prerequisites",level:3},{value:"Customize",id:"customize",level:3},{value:"Deploy",id:"deploy",level:3},{value:"Verify the resources",id:"verify-the-resources",level:2},{value:"Execute Sample Spark job on EMR Virtual Cluster",id:"execute-sample-spark-job-on-emr-virtual-cluster",level:2},{value:"Cleanup",id:"cleanup",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"emr-on-eks-with-cdk-blueprint",children:"EMR on EKS with CDK blueprint"}),"\n",(0,t.jsx)(n.h2,{id:"introduction",children:"Introduction"}),"\n",(0,t.jsxs)(n.p,{children:["In this post, we will learn how to use EMR on EKS AddOn and Teams in the ",(0,t.jsx)(n.code,{children:"cdk-eks-blueprints"})," to deploy a an infrasturcture on EKS to submit Spark Job. The ",(0,t.jsx)(n.code,{children:"cdk-eks-blueprints"})," allows you deploy an EKS cluster and enable it to be used by EMR on EKS service with minimal setup. The architecture below shows a conceptual view of the infrastructure you will deploy through this blueprint."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"EMR on EKS CDK",src:s(9099).Z+"",width:"1816",height:"1180"})}),"\n",(0,t.jsx)(n.h2,{id:"deploying-the-solution",children:"Deploying the Solution"}),"\n",(0,t.jsxs)(n.p,{children:["In this ",(0,t.jsx)(n.a,{href:"https://github.com/awslabs/data-on-eks/tree/main/analytics/cdk/emr-eks",children:"example"}),", you will provision the following:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Creates EKS Cluster Control plane with public endpoint (for demo purpose only)"}),"\n",(0,t.jsxs)(n.li,{children:["Two managed node groups","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Core Node group with 3 AZs for running system critical pods. e.g., Cluster Autoscaler, CoreDNS, Logging etc."}),"\n",(0,t.jsx)(n.li,{children:"Spark Node group with single AZ for running Spark jobs"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["Enable EMR on EKS and create one Data teams (",(0,t.jsx)(n.code,{children:"emr-data-team-a"}),")","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Creates new namespace for each team"}),"\n",(0,t.jsxs)(n.li,{children:["Creates Kubernetes role and role binding(",(0,t.jsx)(n.code,{children:"emr-containers"})," user) for the above namespace"]}),"\n",(0,t.jsx)(n.li,{children:"New IAM role for the team execution role"}),"\n",(0,t.jsx)(n.li,{children:"Update AWS_AUTH config map with  emr-containers user and AWSServiceRoleForAmazonEMRContainers role"}),"\n",(0,t.jsx)(n.li,{children:"Create a trust relationship between the job execution role and the identity of the EMR managed service account"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["EMR Virtual Cluster for ",(0,t.jsx)(n.code,{children:"emr-data-team-a"})]}),"\n",(0,t.jsxs)(n.li,{children:["IAM policy for ",(0,t.jsx)(n.code,{children:"emr-data-team-a"})]}),"\n",(0,t.jsxs)(n.li,{children:["Deploys the following Kubernetes Add-ons","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Managed Add-ons","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"VPC CNI, CoreDNS, KubeProxy, AWS EBS CSi Driver"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["Self Managed Add-ons","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Metrics server with HA, Cluster Autoscaler, CertManager and AwsLoadBalancerController"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["This blueprint can also take an EKS cluster that you defined using the ",(0,t.jsx)(n.code,{children:"cdk-blueprints-library"}),"."]}),"\n",(0,t.jsx)(n.h3,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,t.jsx)(n.p,{children:"Ensure that you have installed the following tools on your machine."}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html",children:"aws cli"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://Kubernetes.io/docs/tasks/tools/",children:"kubectl"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://docs.aws.amazon.com/cdk/v2/guide/getting_started.html#getting_started_install",children:"CDK"})}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"NOTE:"})," You need to have an AWS account and region that are ",(0,t.jsx)(n.a,{href:"https://docs.aws.amazon.com/cdk/v2/guide/getting_started.html#getting_started_bootstrap",children:"bootstrapped"})," by AWS CDK."]}),"\n",(0,t.jsx)(n.h3,{id:"customize",children:"Customize"}),"\n",(0,t.jsxs)(n.p,{children:["The the entry point for this cdk blueprint is ",(0,t.jsx)(n.code,{children:"/bin/emr-eks.ts"})," which instantiate a stack defined in ",(0,t.jsx)(n.code,{children:"lib/emr-eks-blueprint-stack.ts"}),". This stack must be provided with a VPC and a list of EMR on EKS team definition and the role that will be admin of the EKS cluster. It can also take as options an EKS cluster defined through ",(0,t.jsx)(n.code,{children:"cdk-blueprints-library"})," and the EKS cluster name."]}),"\n",(0,t.jsx)(n.p,{children:"The properties that are passed to the emr on eks blueprint stack are defined as such:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"export interface EmrEksBlueprintProps extends StackProps {\n  clusterVpc: IVpc,\n  clusterAdminRoleArn: ArnPrincipal\n  dataTeams: EmrEksTeamProps[],\n  eksClusterName?: string, //Default eksBlueprintCluster\n  eksCluster?: GenericClusterProvider,\n\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:["In this example we define a VPC in ",(0,t.jsx)(n.code,{children:"lib/vpc.ts"})," and is instantiated in ",(0,t.jsx)(n.code,{children:"bin/emr-eks.ts"}),". We also define a team called ",(0,t.jsx)(n.code,{children:"emr-data-team-a"})," and which has an execution role called ",(0,t.jsx)(n.code,{children:"myBlueprintExecRole"}),".\nThe blueprint will deploy by default an EKS cluster with the managed nodegroups defined in the section ",(0,t.jsx)(n.a,{href:"#deploying-the-solution",children:"Deploying the Solution"}),"."]}),"\n",(0,t.jsx)(n.h3,{id:"deploy",children:"Deploy"}),"\n",(0,t.jsxs)(n.p,{children:["Before you run the solution, you ",(0,t.jsx)(n.strong,{children:"MUST"})," change the ",(0,t.jsx)(n.code,{children:"clusterAdminRoleArn"})," of the ",(0,t.jsx)(n.code,{children:"props"})," object in ",(0,t.jsx)(n.code,{children:"lib/emr-eks.ts"}),". This role allows you to interact manage EKS cluster and should have be allowed at least the IAM action ",(0,t.jsx)(n.code,{children:"eks:AccessKubernetesApi"}),"."]}),"\n",(0,t.jsx)(n.p,{children:"Clone the repository"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"git clone https://github.com/awslabs/data-on-eks.git\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Navigate into one of the example directories and run ",(0,t.jsx)(n.code,{children:"cdk synth"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"cd analytics/cdk/emr-eks\nnpm install\ncdk synth --profile YOUR-AWS-PROFILE\n"})}),"\n",(0,t.jsx)(n.p,{children:"Deploy the pattern"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"cdk deploy --all\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Enter ",(0,t.jsx)(n.code,{children:"yes"})," to deploy."]}),"\n",(0,t.jsx)(n.h2,{id:"verify-the-resources",children:"Verify the resources"}),"\n",(0,t.jsxs)(n.p,{children:["Let\u2019s verify the resources created by ",(0,t.jsx)(n.code,{children:"cdk deploy"}),"."]}),"\n",(0,t.jsx)(n.p,{children:"Verify the Amazon EKS Cluster"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"aws eks describe-cluster --name eksBlueprintCluster # Update the name cluster name if you supplied your own\n\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Verify EMR on EKS Namespaces ",(0,t.jsx)(n.code,{children:"batchjob"})," and Pod status for ",(0,t.jsx)(n.code,{children:"Metrics Server"})," and ",(0,t.jsx)(n.code,{children:"Cluster Autoscaler"}),"."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"aws eks --region <ENTER_YOUR_REGION> update-kubeconfig --name eksBlueprintCluster # Creates k8s config file to authenticate with EKS Cluster. Update the name cluster name if you supplied your own\n\nkubectl get nodes # Output shows the EKS Managed Node group nodes\n\nkubectl get ns | grep batchjob # Output shows batchjob\n\nkubectl get pods --namespace=kube-system | grep  metrics-server # Output shows Metric Server pod\n\nkubectl get pods --namespace=kube-system | grep  cluster-autoscaler # Output shows Cluster Autoscaler pod\n"})}),"\n",(0,t.jsx)(n.h2,{id:"execute-sample-spark-job-on-emr-virtual-cluster",children:"Execute Sample Spark job on EMR Virtual Cluster"}),"\n",(0,t.jsx)(n.p,{children:"Execute the Spark job using the below shell script."}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Once you deploy the blueprint you will have as output the Virtual Cluster id. You can use the id and the execution role for which you supplied a policy to submit jobs. Below you can find an example of a job you can submit with AWS CLI."}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'\nexport EMR_ROLE_ARN=arn:aws:iam::<YOUR-ACCOUNT-ID>:role/myBlueprintExecRole\n\naws emr-containers start-job-run \\\n  --virtual-cluster-id=<VIRTUAL-CLUSTER-ID-IN-CDK-OUTPUT> \\\n  --name=pi-2 \\\n  --execution-role-arn=$EMR_ROLE_ARN \\\n  --release-label=emr-6.8.0-latest \\\n  --job-driver=\'{\n    "sparkSubmitJobDriver": {\n      "entryPoint": "local:///usr/lib/spark/examples/src/main/python/pi.py",\n      "sparkSubmitParameters": "--conf spark.executor.instances=1 --conf spark.executor.memory=2G --conf spark.executor.cores=1 --conf spark.driver.cores=1 --conf spark.kubernetes.node.selector.app=spark"\n    }\n  }\'\n\n'})}),"\n",(0,t.jsx)(n.p,{children:"Verify the job execution"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kubectl get pods --namespace=batchjob -w\n"})}),"\n",(0,t.jsx)(n.h2,{id:"cleanup",children:"Cleanup"}),"\n",(0,t.jsx)(n.p,{children:"To clean up your environment, you call the command below. This will destroy the Kubernetes Add-ons, EKS cluster with Node groups and VPC"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"cdk destroy --all\n"})}),"\n",(0,t.jsx)(n.admonition,{type:"caution",children:(0,t.jsx)(n.p,{children:"To avoid unwanted charges to your AWS account, delete all the AWS resources created during this deployment"})})]})}function h(e={}){const{wrapper:n}={...(0,r.a)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},9099:(e,n,s)=>{s.d(n,{Z:()=>t});const t=s.p+"assets/images/emr-eks-cdk-5946f8799f11fb327975c945ade014eb.png"},1151:(e,n,s)=>{s.d(n,{Z:()=>o,a:()=>l});var t=s(7294);const r={},i=t.createContext(r);function l(e){const n=t.useContext(i);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);