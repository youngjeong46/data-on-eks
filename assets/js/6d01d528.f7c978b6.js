"use strict";(self.webpackChunkdoeks_website=self.webpackChunkdoeks_website||[]).push([[806],{3905:(e,t,a)=>{a.d(t,{Zo:()=>u,kt:()=>h});var n=a(7294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function s(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var i=n.createContext({}),p=function(e){var t=n.useContext(i),a=t;return e&&(a="function"==typeof e?e(t):s(s({},t),e)),a},u=function(e){var t=p(e.components);return n.createElement(i.Provider,{value:t},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,o=e.originalType,i=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),c=p(a),m=r,h=c["".concat(i,".").concat(m)]||c[m]||d[m]||o;return a?n.createElement(h,s(s({ref:t},u),{},{components:a})):n.createElement(h,s({ref:t},u))}));function h(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=a.length,s=new Array(o);s[0]=m;var l={};for(var i in t)hasOwnProperty.call(t,i)&&(l[i]=t[i]);l.originalType=e,l[c]="string"==typeof e?e:r,s[1]=l;for(var p=2;p<o;p++)s[p]=a[p];return n.createElement.apply(null,s)}return n.createElement.apply(null,a)}m.displayName="MDXCreateElement"},769:(e,t,a)=>{a.d(t,{Z:()=>m});var n=a(7294),r=a(5697),o=a.n(r),s=a(6010);const l="collapsibleContent_q3kw",i="header_QCEw",p="icon_PckA",u="content_qLC1",c="expanded_iGsi";function d(e){let{children:t,header:a}=e;const[r,o]=(0,n.useState)(!1);return n.createElement("div",{className:l},n.createElement("div",{className:(0,s.Z)(i,{[c]:r}),onClick:()=>{o(!r)}},a,n.createElement("span",{className:(0,s.Z)(p,{[c]:r})})),r&&n.createElement("div",{className:u},t))}d.propTypes={children:o().node.isRequired,header:o().node.isRequired};const m=d},8702:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>p,contentTitle:()=>l,default:()=>m,frontMatter:()=>s,metadata:()=>i,toc:()=>u});var n=a(7462),r=(a(7294),a(3905)),o=a(769);const s={sidebar_position:2,sidebar_label:"Ray on EKS"},l="Ray on EKS",i={unversionedId:"blueprints/ai-ml/ray",id:"blueprints/ai-ml/ray",title:"Ray on EKS",description:"This blueprint should be considered as experimental and should only be used for proof of concept.",source:"@site/docs/blueprints/ai-ml/ray.md",sourceDirName:"blueprints/ai-ml",slug:"/blueprints/ai-ml/ray",permalink:"/data-on-eks/docs/blueprints/ai-ml/ray",draft:!1,editUrl:"https://github.com/awslabs/data-on-eks/blob/main/website/docs/blueprints/ai-ml/ray.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2,sidebar_label:"Ray on EKS"},sidebar:"blueprints",previous:{title:"Introduction",permalink:"/data-on-eks/docs/blueprints/ai-ml/"},next:{title:"JupyterHub on EKS",permalink:"/data-on-eks/docs/blueprints/ai-ml/jupyterhub"}},p={},u=[{value:"Introduction",id:"introduction",level:2},{value:"Ray on Kubernetes",id:"ray-on-kubernetes",level:2},{value:"Deploying the Example",id:"deploying-the-example",level:2},{value:"Clone the repository",id:"clone-the-repository",level:4},{value:"Initialize Terraform",id:"initialize-terraform",level:4},{value:"Run the install script",id:"run-the-install-script",level:4},{value:"XGBoost",id:"xgboost",level:5},{value:"PyTorch",id:"pytorch",level:5}],c={toc:u},d="wrapper";function m(e){let{components:t,...s}=e;return(0,r.kt)(d,(0,n.Z)({},c,s,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"ray-on-eks"},"Ray on EKS"),(0,r.kt)("admonition",{type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"This blueprint should be considered as experimental and should only be used for proof of concept.")),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("p",{parentName:"admonition"},"As part of our ongoing efforts to make this blueprint more enterprise-ready, we are actively working on adding several key functionalities. This includes cost management with Kubecost, advanced observability with OTEL, Amazon Managed Prometheus, and Grafana, as well as improved security and data governance using tools such as OPA/Gatekeeper and IRSA. If you have specific requirements or suggestions for this blueprint, please feel free to open an issue on our GitHub repository.")),(0,r.kt)("h2",{id:"introduction"},"Introduction"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://www.ray.io/"},"Ray")," is an open-source framework for building scalable and distributed applications. It is designed to make it easy to write parallel and distributed Python applications by providing a simple and intuitive API for distributed computing. It has a growing community of users and contributors, and is actively maintained and developed by the Ray team at Anyscale, Inc."),(0,r.kt)("p",null,"To deploy Ray in production across multiple machines users must first deploy ",(0,r.kt)("a",{parentName:"p",href:"https://docs.ray.io/en/latest/cluster/getting-started.html"},(0,r.kt)("strong",{parentName:"a"},"Ray Cluster")),". A Ray Cluster consists of head nodes and worker nodes which can be autoscaled using the built-in ",(0,r.kt)("strong",{parentName:"p"},"Ray Autoscaler"),"."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"RayCluster",src:a(8555).Z,width:"773",height:"388"})),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"Source: ",(0,r.kt)("a",{parentName:"em",href:"https://docs.ray.io/en/latest/cluster/key-concepts.html"},"https://docs.ray.io/en/latest/cluster/key-concepts.html"))),(0,r.kt)("h2",{id:"ray-on-kubernetes"},"Ray on Kubernetes"),(0,r.kt)("p",null,"Deploying Ray Cluster on Kubernetes including on Amazon EKS is supported via the ",(0,r.kt)("a",{parentName:"p",href:"https://ray-project.github.io/kuberay/"},(0,r.kt)("strong",{parentName:"a"},"KubeRay Operator")),". The operator provides a Kubernetes-native way to manage Ray clusters. The installation of KubeRay Operator involves deploying the operator and the CRDs for ",(0,r.kt)("inlineCode",{parentName:"p"},"RayCluster"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"RayJob")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"RayService")," as documented ",(0,r.kt)("a",{parentName:"p",href:"https://ray-project.github.io/kuberay/deploy/helm/"},"here"),"."),(0,r.kt)("p",null,"Deploying Ray on Kubernetes can provide several benefits:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Scalability: Kubernetes allows you to scale your Ray cluster up or down based on your workload requirements, making it easy to manage large-scale distributed applications.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Fault tolerance: Kubernetes provides built-in mechanisms for handling node failures and ensuring high availability of your Ray cluster.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Resource allocation: With Kubernetes, you can easily allocate and manage resources for your Ray workloads, ensuring that they have access to the necessary resources for optimal performance.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Portability: By deploying Ray on Kubernetes, you can run your workloads across multiple clouds and on-premises data centers, making it easy to move your applications as needed.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Monitoring: Kubernetes provides rich monitoring capabilities, including metrics and logging, making it easy to troubleshoot issues and optimize performance."))),(0,r.kt)("p",null,"Overall, deploying Ray on Kubernetes can simplify the deployment and management of distributed applications, making it a popular choice for many organizations that need to run large-scale machine learning workloads."),(0,r.kt)("p",null,"Before moving forward with the deployment please make sure you have read the pertinent sections of the official ",(0,r.kt)("a",{parentName:"p",href:"https://docs.ray.io/en/latest/cluster/kubernetes/index.html"},"documentation"),"."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"RayonK8s",src:a(6256).Z,width:"1708",height:"686"})),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"Source: ",(0,r.kt)("a",{parentName:"em",href:"https://docs.ray.io/en/latest/cluster/kubernetes/index.html"},"https://docs.ray.io/en/latest/cluster/kubernetes/index.html"))),(0,r.kt)("h2",{id:"deploying-the-example"},"Deploying the Example"),(0,r.kt)("p",null,"In this ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/awslabs/data-on-eks/tree/main/ai-ml/ray/terraform"},"example"),", you will provision Ray Cluster on Amazon EKS using the KubeRay Operator. The example also demonstrates the use of Karpenter of autoscaling of worker nodes for job specific Ray Clusters."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"RayOnEKS",src:a(8738).Z,width:"1403",height:"1184"})),(0,r.kt)(o.Z,{header:(0,r.kt)("h3",null,(0,r.kt)("span",null,"Pre-requisites")),mdxType:"CollapsibleContent"},(0,r.kt)("p",null,"Ensure that you have installed the following tools on your machine."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html"},"aws cli")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"https://Kubernetes.io/docs/tasks/tools/"},"kubectl")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"https://learn.hashicorp.com/tutorials/terraform/install-cli"},"terraform")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"https://www.python.org/"},"python3")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"https://docs.ray.io/en/master/ray-overview/installation.html#from-wheels"},"ray")))),(0,r.kt)(o.Z,{header:(0,r.kt)("h3",null,(0,r.kt)("span",null,"Deploy the EKS Cluster with KubeRay Operator")),mdxType:"CollapsibleContent"},(0,r.kt)("h4",{id:"clone-the-repository"},"Clone the repository"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"git clone https://github.com/awslabs/data-on-eks.git\n")),(0,r.kt)("h4",{id:"initialize-terraform"},"Initialize Terraform"),(0,r.kt)("p",null,"Navigate into the example directory"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"cd data-on-eks/ai-ml/ray/terraform\n")),(0,r.kt)("h4",{id:"run-the-install-script"},"Run the install script"),(0,r.kt)("p",null,"Use the provided helper script ",(0,r.kt)("inlineCode",{parentName:"p"},"install.sh")," to run the terraform init and apply commands. By default the script deploys EKS cluster to ",(0,r.kt)("inlineCode",{parentName:"p"},"us-west-2")," region. Update ",(0,r.kt)("inlineCode",{parentName:"p"},"variables.tf")," to change the region. This is also the time to update any other input variables or make any other changes to the terraform template."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"./install .sh\n"))),(0,r.kt)(o.Z,{header:(0,r.kt)("h3",null,(0,r.kt)("span",null,"Verify Deployment")),mdxType:"CollapsibleContent"},(0,r.kt)("p",null,"Update local kubeconfig so we can access kubernetes cluster"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"aws eks update-kubeconfig --name ray-cluster #or whatever you used for EKS cluster name\n")),(0,r.kt)("p",null,"First, lets verify that we have worker nodes running in the cluster."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kuebctl get nodes\n")),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("pre",{parentName:"admonition"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"NAME                          STATUS   ROLES    AGE   VERSION\nip-10-1-26-241.ec2.internal   Ready    <none>   10h   v1.24.9-eks-49d8fe8\nip-10-1-4-21.ec2.internal     Ready    <none>   10h   v1.24.9-eks-49d8fe8\nip-10-1-40-196.ec2.internal   Ready    <none>   10h   v1.24.9-eks-49d8fe8\n"))),(0,r.kt)("p",null,"Next, lets verify all the pods are running."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl get pods -n kuberay-operator\n")),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("pre",{parentName:"admonition"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"NAMESPACE            NAME                               READY   STATUS    RESTARTS        AGE\namazon-cloudwatch    aws-cloudwatch-metrics-d4xrr       1/1     Running   1 (1h37m ago)   1h\namazon-cloudwatch    aws-cloudwatch-metrics-tpqsz       1/1     Running   1 (1h37m ago)   1h\namazon-cloudwatch    aws-cloudwatch-metrics-z7wbn       1/1     Running   1 (1h37m ago)   1h\naws-for-fluent-bit   aws-for-fluent-bit-h82w4           1/1     Running   1 (1h37m ago)   1h\naws-for-fluent-bit   aws-for-fluent-bit-r5kxt           1/1     Running   1 (1h37m ago)   1h\naws-for-fluent-bit   aws-for-fluent-bit-wgxxl           1/1     Running   1 (1h37m ago)   1h\nkarpenter            karpenter-668c669897-fmxdr         1/1     Running   1 (1h37m ago)   1h\nkarpenter            karpenter-668c669897-prbr6         1/1     Running   1 (1h37m ago)   1h\nkube-system          aws-node-fnwp5                     1/1     Running   1 (1h37m ago)   1h\nkube-system          aws-node-r45xd                     1/1     Running   1 (1h37m ago)   1h\nkube-system          aws-node-vfq66                     1/1     Running   1 (1h37m ago)   1h\nkube-system          coredns-79989457d9-2jldd           1/1     Running   1 (1h37m ago)   1h\nkube-system          coredns-79989457d9-cgtkf           1/1     Running   1 (1h37m ago)   1h\nkube-system          kube-proxy-5jrtf                   1/1     Running   1 (1h37m ago)   1h\nkube-system          kube-proxy-fjxsk                   1/1     Running   1 (1h37m ago)   1h\nkube-system          kube-proxy-tzr79                   1/1     Running   1 (1h37m ago)   1h\nkuberay-operator     kuberay-operator-7b5c85998-vfsjr   1/1     Running   1 (1h37m ago)   1h\n"))),(0,r.kt)("p",null,"At this point we are ready to deploy Ray Clusters.")),(0,r.kt)(o.Z,{header:(0,r.kt)("h3",null,(0,r.kt)("span",null,"Deploy Ray Clusters and Workloads")),mdxType:"CollapsibleContent"},(0,r.kt)("p",null,"For convenience, we have packaged the helm chart deployent of Ray Cluster as a repeatable terraform ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/awslabs/data-on-eks/tree/main/ai-ml/ray/terraform/modules/ray-cluster/"},"module"),". This allows us to codify organizational best practices and requirements for deploying Ray Clusters for multiple Data Science teams. The module also creates configuration needed for karpenter to be able to provision EC2 instances for Ray applications as and when they are needed for the duration of the job. This model can be replicated via GitOps tooling such as ArgoCD or Flux but is done here via terraform for demonstration purpose."),(0,r.kt)("h5",{id:"xgboost"},"XGBoost"),(0,r.kt)("p",null,"First, we will deploy a Ray Cluster for our ",(0,r.kt)("a",{parentName:"p",href:"https://docs.ray.io/en/latest/cluster/kubernetes/examples/ml-example.html#kuberay-ml-example"},"XGBoost benchmark")," sample job."),(0,r.kt)("p",null,"Go to the xgboost directory followed by terraform init, and plan."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"cd examples/xgboost\nterraform init\nterraform plan\n")),(0,r.kt)("p",null,"If the changes look good, lets apply them."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"terraform apply -auto-approve\n")),(0,r.kt)("p",null,"As the RayCluster pod goes into the pending state, Karpenter will provision an EC2 instance based on the ",(0,r.kt)("inlineCode",{parentName:"p"},"Provisioner")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"AWSNodeTemplate")," configuration we have provided. We can check that a new node has been created."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl get nodes\n")),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("pre",{parentName:"admonition"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"NAME                          STATUS   ROLES    AGE     VERSION\n# New node appears\nip-10-1-13-204.ec2.internal   Ready    <none>   2m22s   v1.24.9-eks-49d8fe8\nip-10-1-26-241.ec2.internal   Ready    <none>   12h     v1.24.9-eks-49d8fe8\nip-10-1-4-21.ec2.internal     Ready    <none>   12h     v1.24.9-eks-49d8fe8\nip-10-1-40-196.ec2.internal   Ready    <none>   12h     v1.24.9-eks-49d8fe8\n"))),(0,r.kt)("p",null,"Wait until the RayCluster head node pods are provisioned."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl get pods -n xgboost\n")),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("pre",{parentName:"admonition"},(0,r.kt)("code",{parentName:"pre"},"NAME                         READY   STATUS    RESTARTS   AGE\nxgboost-kuberay-head-585d6   2/2     Running   0          5m42s\n"))),(0,r.kt)("p",null,"Now we are ready to run our sample training benchmark using for XGBoost. First, open another terminal and forward the Ray server to our localhost."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"kubectl port-forward service/xgboost-kuberay-head-svc -n xgboost 8265:8265\n")),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("pre",{parentName:"admonition"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"Forwarding from 127.0.0.1:8265 -> 8265\nForwarding from [::1]:8265 -> 8265\n"))),(0,r.kt)("p",null,"Submit the ray job for XGBoost benchmark."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"python job/xgboost_submit.py\n")),(0,r.kt)("p",null,"You can open http://localhost:8265 in your browser to monitor job progress. If there are any failures during execution those can be viewed in the logs under the Jobs section."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"RayDashboard",src:a(9344).Z,width:"1920",height:"953"})),(0,r.kt)("p",null,"As the job progresses, you will notice new Ray autoscaler will provision additional ray worker pods based on the autoscaling configuration defined in the RayCluster configuration. Those worker pods will initially remain in pending state. That will trigger karpenter to spin up new EC2 instances so the pending pods can be scheduled. After worker pods go to running state, the job will progress to completion."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl get nodes\n")),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("pre",{parentName:"admonition"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"NAME                          STATUS    ROLES    AGE   VERSION\nip-10-1-1-241.ec2.internal    Unknown   <none>   1s  \nip-10-1-10-211.ec2.internal   Unknown   <none>   1s  \nip-10-1-13-204.ec2.internal   Ready     <none>   24m   v1.24.9-eks-49d8fe8\nip-10-1-26-241.ec2.internal   Ready     <none>   12h   v1.24.9-eks-49d8fe8\nip-10-1-3-64.ec2.internal     Unknown   <none>   7s  \nip-10-1-4-21.ec2.internal     Ready     <none>   12h   v1.24.9-eks-49d8fe8\nip-10-1-40-196.ec2.internal   Ready     <none>   12h   v1.24.9-eks-49d8fe8\nip-10-1-7-167.ec2.internal    Unknown   <none>   1s  \nip-10-1-9-112.ec2.internal    Unknown   <none>   1s  \nip-10-1-9-172.ec2.internal    Unknown   <none>   1s  \n"))),(0,r.kt)("p",null,"Optionally, you can also use ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/awslabs/eks-node-viewer"},"eks-node-viewer")," for visualizing dynamic node usage within the cluster."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"EksNodeViewer",src:a(1305).Z,width:"861",height:"330"})),(0,r.kt)("p",null,"Once the benchmark is complete, the job log will display the results. You might see different results based on your configurations."),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("pre",{parentName:"admonition"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"Results: {'training_time': 1338.488839321999, 'prediction_time': 403.36653568099973}\n"))),(0,r.kt)("h5",{id:"pytorch"},"PyTorch"),(0,r.kt)("p",null,"We can simultaneously deploy the PyTorch benchmark as well. We deploy a separate Ray Cluster with its own configuration for Karpenter workers. Different jobs can have different requirements for Ray Cluster such as a different version of Ray libraries or EC2 instance configuration such as making use of Spot market or GPU instances. We take advantage of node taints and tolerations in Ray Cluster pod specs to match the Ray Cluster configuration to Karpenter configuration thus taking advantage of the flexibility that Karpenter provides."),(0,r.kt)("p",null,"Go to the PyTorch directory and run the terraform init and plan as before."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"cd ../pytorch\nterraform init\nterraform plan\n")),(0,r.kt)("p",null,"Apply the changes."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"terraform apply -auto-approve\n")),(0,r.kt)("p",null,"Wait for the pytorch Ray Cluster head node pods to be ready."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl get pods -n pytorch -w\n")),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("pre",{parentName:"admonition"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"NAME                         READY   STATUS    RESTARTS   AGE\npytorch-kuberay-head-9tx56   0/2     Pending   0          43s\n"))),(0,r.kt)("p",null,"Once running, we can forward the port for server, taking care that we foward it to another local port as 8265 may be occupied by the xgboost connection."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl port-forward service/pytorch-kuberay-head-svc -n pytorch 8266:8265\n")),(0,r.kt)("p",null,"We can then submit the job for PyTorch benchmark workload."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"python job/pytorch_submit.py\n")),(0,r.kt)("p",null,"You can open http://localhost:8266 to monitor the progress of the pytorch benchmark.")),(0,r.kt)(o.Z,{header:(0,r.kt)("h3",null,(0,r.kt)("span",null,"Teardown")),mdxType:"CollapsibleContent"},(0,r.kt)("admonition",{type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"To avoid unwanted charges to your AWS account, delete all the AWS resources created during this deployment.")),(0,r.kt)("p",null,"Destroy the Ray Clusters for pytorch followed by xgboost."),(0,r.kt)("p",null,"From the pytorch directory."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"cd ../pytorch\nterraform destroy -auto-approve\n")),(0,r.kt)("p",null,"From the xgboost directory."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"cd ../xgboost\nterraform destroy -auto-approve\n")),(0,r.kt)("p",null,"Use the provided helper script ",(0,r.kt)("inlineCode",{parentName:"p"},"cleanup.sh")," to tear down EKS cluster and other AWS resources."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"cd ../../\n./cleanup.sh\n"))))}m.isMDXComponent=!0},1305:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/eks-node-viewer-00ad3fc9c73a984f048dee4345f8d27d.png"},8555:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/ray-cluster-8928896ee110a20b193fa95f297970a5.svg"},9344:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/ray-dashboard-9f00fe9aadf91cf8a6fb2b53d9ae66b2.png"},8738:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/ray-on-eks-b55f9b97ff12f6073d1c005e1a75e142.png"},6256:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/ray_on_kubernetes-5882d71319bfc6b44d7da61e25a0c122.webp"}}]);