"use strict";(self.webpackChunkdoeks_website=self.webpackChunkdoeks_website||[]).push([[8282],{3905:(e,t,r)=>{r.d(t,{Zo:()=>c,kt:()=>h});var o=r(7294);function n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function a(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,o)}return r}function s(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?a(Object(r),!0).forEach((function(t){n(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):a(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function i(e,t){if(null==e)return{};var r,o,n=function(e,t){if(null==e)return{};var r,o,n={},a=Object.keys(e);for(o=0;o<a.length;o++)r=a[o],t.indexOf(r)>=0||(n[r]=e[r]);return n}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)r=a[o],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(n[r]=e[r])}return n}var l=o.createContext({}),u=function(e){var t=o.useContext(l),r=t;return e&&(r="function"==typeof e?e(t):s(s({},t),e)),r},c=function(e){var t=u(e.components);return o.createElement(l.Provider,{value:t},e.children)},d="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},m=o.forwardRef((function(e,t){var r=e.components,n=e.mdxType,a=e.originalType,l=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),d=u(r),m=n,h=d["".concat(l,".").concat(m)]||d[m]||p[m]||a;return r?o.createElement(h,s(s({ref:t},c),{},{components:r})):o.createElement(h,s({ref:t},c))}));function h(e,t){var r=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var a=r.length,s=new Array(a);s[0]=m;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i[d]="string"==typeof e?e:n,s[1]=i;for(var u=2;u<a;u++)s[u]=r[u];return o.createElement.apply(null,s)}return o.createElement.apply(null,r)}m.displayName="MDXCreateElement"},4019:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>p,frontMatter:()=>a,metadata:()=>i,toc:()=>u});var o=r(7462),n=(r(7294),r(3905));const a={},s="Troubleshooting",i={unversionedId:"blueprints/troubleshooting/troubleshooting",id:"blueprints/troubleshooting/troubleshooting",title:"Troubleshooting",description:"You will find troubleshooting info for Data on Amazon EKS(DoEKS) installation issues",source:"@site/docs/blueprints/troubleshooting/troubleshooting.md",sourceDirName:"blueprints/troubleshooting",slug:"/blueprints/troubleshooting/",permalink:"/data-on-eks/docs/blueprints/troubleshooting/",draft:!1,editUrl:"https://github.com/awslabs/data-on-eks/blob/main/website/docs/blueprints/troubleshooting/troubleshooting.md",tags:[],version:"current",frontMatter:{},sidebar:"blueprints",previous:{title:"CloudNativePG PostgreSQL",permalink:"/data-on-eks/docs/blueprints/distributed-databases/cloudnative-postgres"}},l={},u=[{value:"Error: local-exec provisioner error",id:"error-local-exec-provisioner-error",level:2},{value:"Solution",id:"solution",level:3},{value:"Timeouts during Terraform Destroy",id:"timeouts-during-terraform-destroy",level:2},{value:"Solution",id:"solution-1",level:3},{value:"Forbidden! Configured service account doesn&#39;t have access",id:"forbidden-configured-service-account-doesnt-have-access",level:2},{value:"Solution",id:"solution-2",level:3},{value:"Error: could not download chart",id:"error-could-not-download-chart",level:2},{value:"Solution",id:"solution-3",level:3}],c={toc:u},d="wrapper";function p(e){let{components:t,...r}=e;return(0,n.kt)(d,(0,o.Z)({},c,r,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("h1",{id:"troubleshooting"},"Troubleshooting"),(0,n.kt)("p",null,"You will find troubleshooting info for Data on Amazon EKS(DoEKS) installation issues"),(0,n.kt)("h2",{id:"error-local-exec-provisioner-error"},"Error: local-exec provisioner error"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-sh"},'Error: local-exec provisioner error \\\nwith module.eks-blueprints.module.emr_on_eks["data_team_b"].null_resource.update_trust_policy,\\\n on .terraform/modules/eks-blueprints/modules/emr-on-eks/main.tf line 105, in resource "null_resource" \\\n "update_trust_policy":\u2502 105: provisioner "local-exec" {\u2502 \u2502 Error running command \'set -e\u2502 \u2502 aws emr-containers update-role-trust-policy \\\n \u2502 --cluster-name emr-on-eks \\\u2502 --namespace emr-data-team-b \\\u2502 --role-name emr-on-eks-emr-eks-data-team-b\n')),(0,n.kt)("h3",{id:"solution"},"Solution"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"emr-containers not present in cli version 2.0.41 Python/3.7.4. For more ",(0,n.kt)("a",{parentName:"li",href:"https://github.com/aws/aws-cli/issues/6162"},"details"),"\nThis is fixed in version 2.0.54."),(0,n.kt)("li",{parentName:"ul"},"Action: aws cli version should be updated to 2.0.54 or later : Execute ",(0,n.kt)("inlineCode",{parentName:"li"},"pip install --upgrade awscliv2 "))),(0,n.kt)("h2",{id:"timeouts-during-terraform-destroy"},"Timeouts during Terraform Destroy"),(0,n.kt)("p",null,"Customers who are deleting their environments using terraform destroy may see timeout errors when VPCs are being deleted. This is due to a known issue in the ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/aws/amazon-vpc-cni-k8s/issues/1223#issue-704536542"},"vpc-cni")),(0,n.kt)("p",null,"Customers may face a situation where ENIs that were attached to EKS managed nodes (same may apply to self-managed nodes) are not being deleted by the VPC CNI as expected which leads to IaC tool failures, such as:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"ENIs are left on subnets"),(0,n.kt)("li",{parentName:"ul"},"EKS managed security group which is attached to the ENI can\u2019t be deleted by EKS")),(0,n.kt)("h3",{id:"solution-1"},"Solution"),(0,n.kt)("p",null,"The current recommendation is to execute cleanup in the following order:"),(0,n.kt)("p",null,"delete all pods that have been created in the cluster.\nadd delay/ wait\ndelete VPC CNI\ndelete nodes\ndelete cluster"),(0,n.kt)("h2",{id:"forbidden-configured-service-account-doesnt-have-access"},"Forbidden! Configured service account doesn't have access"),(0,n.kt)("p",null,"Error:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},'io.fabric8.kubernetes.client.KubernetesClientException: Failure executing: PATCH at: https://kubernetes.default.svc/api/v1/namespaces/emr-team-a/pods/createnosaprocessedactions-772b9c81ae56a93d-exec-394. Message: Forbidden!Configured service account doesn\'t have access. Service account may have been revoked. pods "createnosaprocessedactions-772b9c81ae56a93d-exec-394" is forbidden: User "system:serviceaccount:emr-team-a:emr-containers-sa-spark-driver-682942051493-76simz7hn0n7qw78flb3z0c1ldt10ou9nmbeg8sh29" cannot patch resource "pods" in API group "" in the namespace "emr-team-a".\n')),(0,n.kt)("h3",{id:"solution-2"},"Solution"),(0,n.kt)("p",null,"The following script patches the Kubernetes roles created by EMR job execution for given namespace.\nThis is a mandatory fix for ",(0,n.kt)("inlineCode",{parentName:"p"},"EMR6.6/Spark3.2")," for missing permissions. This issue will be resolved in future release e.g., EMR6.7 and the patch script may not be required\nRepeat the above tests after applying the patch. This script needs to be run for all the namespaces used by by EMR on EKS Jobs"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-sh"},'cd analytics/emr-eks-fsx-lustre/fsx_lustre\npython3 emr-eks-sa-fix.py -n "emr-data-team-a"\n')),(0,n.kt)("h2",{id:"error-could-not-download-chart"},"Error: could not download chart"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},'\u2502 Error: could not download chart: failed to download "oci://public.ecr.aws/karpenter/karpenter" at version "v0.18.1"\n\u2502\n\u2502   with module.eks_blueprints_kubernetes_addons.module.karpenter[0].module.helm_addon.helm_release.addon[0],\n\u2502   on .terraform/modules/eks_blueprints_kubernetes_addons/modules/kubernetes-addons/helm-addon/main.tf line 1, in resource "helm_release" "addon":\n\u2502    1: resource "helm_release" "addon" {\n\u2502\n')),(0,n.kt)("h3",{id:"solution-3"},"Solution"),(0,n.kt)("p",null,"Looks like there is a bug in Terraform while doing Karpenter install. Until this is fixed, you can authenticate with ECR and re-run ",(0,n.kt)("inlineCode",{parentName:"p"},"terraform apply")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"aws ecr-public get-login-password --region us-east-1 | docker login --username AWS --password-stdin public.ecr.aws\nterraform apply --auto-approve\n")))}p.isMDXComponent=!0}}]);